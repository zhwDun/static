<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>接口列表编辑</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="lib/layui/css/layui.css" media="all">
    <script src="lib/layui/layui.js" charset="utf-8"></script>
    <script src="lib/jquery-3.3.1.js" charset="utf-8"></script>

    <script src="js/url_timestamp.js"></script>
</head>

<body>
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>请求头</legend>
    </fieldset>

    <form class="layui-form" lay-filter="formTest" action="">
        <div class="layui-form-item">
            <label class="layui-form-label">接口名</label>
            <div class="layui-input-inline">
                <input type="text" name="interface_name" lay-verify="title" autocomplete="off" placeholder="请输入接口名称"
                    class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">系统选择</label>
            <div class="layui-input-inline">
                <select name="system">
                    <option value="核心系统" selected="">核心系统</option>
                    <option value="信贷系统">信贷系统</option>
                    <option value="电票系统">电票系统</option>
                    <option value="双乾系统">双乾系统</option>
                    <option value="企业网银">企业网银</option>
                    <option value="信贷系统">信贷系统</option>
                    <option value="电票系统">电票系统</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="sub_system">
                    <option value="二手房">二手房</option>
                    <option value="360助贷" selected="">360助贷</option>
                    <option value="tongyiyunyin">统一运营</option>
                    <option value="等等">等等</option>
                    <option value="其他">其他</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="module">
                    <option value="西湖区">西湖区</option>
                    <option value="余杭区">余杭区</option>
                    <option value="网贷" selected="">网贷</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">请求协议</label>
            <div class="layui-input-inline">
                <select name="request_protocol">
                    <option value="HTTP" selected="">HTTP</option>
                    <option value="SMDP">HTTPS</option>
                    <option value="TCP">TCP</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">请求方法</label>
            <div class="layui-input-inline">
                <select name="request_method">
                    <option value="POST" selected="">POST</option>
                    <option value="GET">GET</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">服务器名称</label>
            <div class="layui-input-inline">
                <input type="text" name="request_ip" lay-verify="ipAddress" placeholder="例如 127.0.0.1" autocomplete="on"
                    class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">端口号</label>
            <div class="layui-input-inline">
                <input type="text" name="request_port" lay-verify="ipPort" placeholder="例如 8008" autocomplete="on"
                    class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">路径</label>
            <div class="layui-input-inline">
                <input type="text" name="request_path" lay-verify="ipPath" placeholder="例如 /address" autocomplete="on"
                    class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" id="head">
            <label class="layui-form-label">信息头</label>
            <div class="layui-input-inline">
                <input type="text" name="header.name[0]" id="HandoverCompany_0" class="layui-input"
                    style="position:absolute;z-index:2;width:80%;" lay-verify="required" value="编辑或选择"
                    autocomplete="off">
                <select type="text" id="hc_select_0" lay-filter="hc_select_0" autocomplete="off" placeholder="移交单位全称"
                    lay-verify="required">
                    <option value="">请选信息头</option>
                    <option value="Accept">Accept</option>
                    <option value="Accept-Encoding">Accept-Encoding</option>
                    <option value="Accept-Language">Accept-Language</option>
                    <option value="Authorization">Authorization</option>
                    <option value="Host">Host</option>
                    <option value="User-Agent">User-Agent</option>
                    <option value="cookie">cookie</option>
                    <option value="Content-Type" selected="">Content-Type</option>
                    <option value="Content-Length">Content-Length</option>
                    <option value="Connection">Connection</option>
                    <option value="Accept-Charset">Accept-Charset</option>
                    <option value="Referer">Referer</option>
                    <option value="From">From</option>
                </select>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">参数值</label>
                <div class="layui-input-inline">
                    <input type="text" name="header.value[0]" autocomplete="off" class="layui-input"
                        placeholder=" 例如&nbsp;application/json">
                </div>
                <input type="button" class="layui-btn" id="add" value="新增">
            </div>
            <br>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">报文</label>
            <div class="layui-input-block">
                <textarea class="layui-textarea " name="request_message" lay-verify="content_json"
                    placeholder="请输入报文"></textarea>
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">接口描述</label>
            <div class="layui-input-block">
                <textarea class="layui-textarea " name="interface_description" lay-verify="content"
                    placeholder="请输入接口描述"></textarea>
            </div>
        </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <input class="layui-btn" lay-submit="" type="button" lay-filter="demo1" value="立即提交">
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
    <script>
        // post  http://192.168.30.35:8000/api/paramter/    信息头可以自定义
        var count = 0;
        var $;
        layui.use(['form', 'layedit', 'laydate', 'jquery'], function () {
            var form = layui.form,
                layer = layui.layer,
                $ = layui.jquery,
                layedit = layui.layedit,
                laydate = layui.laydate;
            //创建一个编辑器
            var editIndex = layedit.build('LAY_demo_editor');

            //获取编辑接口指定数据
            $(function () {
                // $.ajax({
                //     url: 'http://192.168.30.35:8000/api/paramter/14/',
                //     type: "get",
                //     async: false,
                //     datType: "json",
                //     success: function (data) {
                //         interface_message = data;
                //         //初始化赋值
                //         $("#interface_name").val(interface_message.data.interface_name);

                //         form.render();
                //     }
                // })


                var str_1 = "{\r\n" +
                    "	\"id\": 1,\r\n" +
                    "	\"operator\": \"yangsheng\",\r\n" +
                    "	\"ip\": \"192.168.30.35\",\r\n" +
                    "	\"create_time\": \"2019-06-24 03:13:11\",\r\n" +
                    "	\"update_time\": \"2019-06-24 03:13:11\",\r\n" +
                    "	\"interface_name\": \"信贷接口\",\r\n" +
                    "	\"system\": \"信贷系统\",\r\n" +
                    "	\"sub_system\": \"tongyiyunyin\",\r\n" +
                    "	\"module\": \"余杭区\",\r\n" +
                    "	\"request_header\": \"{\\\"Content-Type\\\": \\\"aaaaaaaa\\\", \\\"Host\\\": \\\"sssssss\\\"}\",\r\n" +
                    "	\"request_protocol\": \"HTTP\",\r\n" +
                    "	\"request_ip\": \"127.0.0.1\",\r\n" +
                    "	\"request_port\": \"8008\",\r\n" +
                    "	\"request_method\": \"POST\",\r\n" +
                    "	\"request_path\": \"/addknsnk\",\r\n" +
                    "	\"request_message\": \"{\\\"name\\\":\\\"aaaaa\\\",\\\"systemchose1\\\":\\\"信贷系统\\\",\\\"systemchose2\\\":\\\"tongyiyunyin\\\",\\\"systemchose3\\\":\\\"余杭区\\\",\\\"agreement\\\":\\\"HTTP\\\",\\\"method\\\":\\\"POST\\\",\\\"ip\\\":\\\"127.0.0.1\\\",\\\"port\\\":\\\"8008\\\",\\\"address\\\":\\\"/addadd\\\",\\\"header.name[0]\\\":\\\"Content-Type\\\",\\\"header.value[0]\\\":\\\"\\\",\\\"baowen-notBody\\\":\\\"{}\\\",\\\"baowen-body\\\":\\\"{}\\\",\\\"interface-description\\\":\\\"{}\\\"}\",\r\n" +
                    "	\"interface_description\": \"sadasdadadad\",\r\n" +
                    "	\"header.name[0]\": \"Content-Type\",\r\n" +
                    "	\"header.value[0]\": \"aaaaaaaa\",\r\n" +
                    "	\"header.name[1]\": \"Content-a\",\r\n" +
                    "	\"header.value[1]\": \"aaaaaaaa\",\r\n" +
                    "	\"header.name[2]\": \"Host\",\r\n" +
                    "	\"header.value[2]\": \"sssssss\"\r\n" +

                    "}";
                var jsonObj = eval('(' + str_1 + ')');
                // console.log(jsonObj);
                var myJson = jsonObj;

                var count_head = -1;
                for (var val in myJson) {

                    pattern = /header.name\[\d\]/;
                    console.log(pattern.test(val));
                    if (pattern.test(val)) {
                        count_head++;
                    }

                    // console.log(val + " " + myJson[val])
                }
                count = count_head;

                let j = 0;
                // 模拟点击事件
                $('#add').bind("myClick", function () {
                    var str =
                        '<label class="layui-form-label">信息头</label>' +
                        ' <div class="layui-input-inline">' +
                        ' <input type="text" name="header.name[' + j +
                        ']" id="HandoverCompany_' + j +
                        // '" class="layui-input" style="position:absolute;z-index:2;width:80%;" lay-verify="required" value="111" onkeyup="search()" autocomplete="off">' +
                        '" class="layui-input" style="position:absolute;z-index:2;width:80%;" lay-verify="required" value="编辑或选择"+autocomplete="off">' +
                        // '<select name="header.name[' + j +
                        // ']" lay-verify="distinctvalue">' +
                        '<select type="text" id="hc_select_' + j +
                        '" lay-filter="hc_select_' + j +
                        '" autocomplete="off" placeholder="移交单位全称" lay-verify="required">' +
                        // class="layui-select" lay-search
                        '<option value="">请选信息头</option>' +
                        '<option value="Accept">Accept</option>' +
                        '<option value="Accept-Encoding">Accept-Encoding</option>' +
                        '<option value="Accept-Language">Accept-Language</option>' +
                        '<option value="Authorization">Authorization</option>' +
                        '<option value="Host">Host</option>' +
                        '<option value="User-Agent">User-Agent</option>' +
                        '<option value="cookie">cookie</option>' +
                        '<option value="Content-Type" selected="">Content-Type</option>' +
                        '<option value="Content-Length">Content-Length</option>' +
                        '<option value="Connection">Connection</option>' +
                        '<option value="Accept-Charset">Accept-Charset</option>' +
                        '<option value="Referer">Referer</option>' +
                        '<option value="From">From</option>' +
                        '</select>' +
                        '</div>' +
                        '<div class="layui-inline">' +
                        '<label class="layui-form-label">参数值</label>' +
                        '<div class="layui-input-inline">' +
                        '<input type="text" name="header.value[' + j +
                        ']" autocomplete="off" class="layui-input" placeholder=" 例如&nbsp;application/json">' +
                        '</div>' +
                        '<input type="button" class="layui-btn" onclick="deleteTr(this)" value="删除">' +
                        '</div>' +
                        '<br>'
                    $('#head').append(str);
                });
                if (count_head > 0) {
                    for (let i = 1; i < count_head + 1; i++) {
                        //触发模拟点击
                        j = i;
                        $('#add').trigger("myClick");
                    }

                }
                
                layui.use('form', function () {
                    let form = layui.form; 
                    form.render();
                });
                //选择移交单位 赋值给input框
                for (let i = 1; i <= count; i++) {
                        form.on('select(hc_select_' + i + ')', function (
                            data) {
                            $('#HandoverCompany_' + i + '').val(data.value);
                            $('#hc_select_' + i + '').next().find("dl").css({
                                "display": "none"
                            });
                            form.render();
                        });
                    }
                form.val('formTest',
                    myJson
                )
            });



            //监听提交
            form.on('submit(demo1)', function (data) {
                console.log(JSON.stringify(data.field))
                layer.alert(JSON.stringify(data.field), {
                    title: '最终的提交信息'
                })
                $.ajax({
                    url: 'http://192.168.30.35:8000/api/paramter/',
                    // contentType: 'application/json',
                    method: 'post',
                    data: data.field,
                    // data:JSON.stringify(data.field),
                    // dataType:'JSON',
                    success: function (res) {
                        if (res.code = '0') {
                            parent.closeIframe(res.msg);
                        } else
                            alert(res.msg);
                    },
                    error: function (data) {
                        // alert(data.error);
                    }
                });
            });
            //自定义验证规则
            form.verify({
                title: function (value) {
                    if (value.length <= 0) {
                        return '接口名不能为空';
                    }
                },
                ipAddress: [
                    /((25[0-5]|2[0-4]\d|((1\d{2})|([1-9]?\d)))\.){3}(25[0-5]|2[0-4]\d|((1\d{2})|([1-9]?\d)))/,
                    '不是有效的IP地址！'
                ],
                ipPort: [
                    /^([0-9]|[1-9]\d|[1-9]\d{2}|[1-9]\d{3}|[1-5]\d{4}|6[0-4]\d{3}|65[0-4]\d{2}|655[0-2]\d|6553[0-5])$/,
                    '不是有效的IP端口！'
                ],
                ipPath: function (value) {
                    if (value.length > 0) {
                        ipPath: [/^\//, '不是有效的IP路径！'];
                    }
                },
                required: function (value) {
                    var head_arry = [];
                    for (let i = 0; i <= count; i++) {
                        var values1 = $('#HandoverCompany_' + i + '').val();
                        head_arry = head_arry.concat(values1);
                        var nary = head_arry.sort();
                        for (var j = 0; j < head_arry.length; j++) {
                            if (nary[j] == nary[j + 1]) {
                                return "信息头不可重复"
                            }
                        }
                    }
                },
                content_json: function (value) {
                    if (typeof value == 'string') {
                        try {
                            var obj = JSON.parse(value);
                            if (typeof obj == 'object' && obj) {

                            } else {
                                return 'json格式不正确';
                            }

                        } catch (e) {
                            console.log('error：' + value + '!!!' + e);
                            return 'json格式不正确';
                        }
                    }
                }
            });

            //监听新增
            $(document).ready(function () {
                $("#add").click(function () {
                    count++;
                    var str =
                        '<label class="layui-form-label">信息头</label>' +
                        ' <div class="layui-input-inline">' +
                        ' <input type="text" name="header.name[' + count +
                        ']" id="HandoverCompany_' + count +
                        // '" class="layui-input" style="position:absolute;z-index:2;width:80%;" lay-verify="required" value="111" onkeyup="search()" autocomplete="off">' +
                        '" class="layui-input" style="position:absolute;z-index:2;width:80%;" lay-verify="required" value="编辑或选择"+autocomplete="off">' +
                        // '<select name="header.name[' + count +
                        // ']" lay-verify="distinctvalue">' +
                        '<select type="text" id="hc_select_' + count +
                        '" lay-filter="hc_select_' + count +
                        '" autocomplete="off" placeholder="移交单位全称" lay-verify="required">' +
                        // class="layui-select" lay-search
                        '<option value="">请选信息头</option>' +
                        '<option value="Accept">Accept</option>' +
                        '<option value="Accept-Encoding">Accept-Encoding</option>' +
                        '<option value="Accept-Language">Accept-Language</option>' +
                        '<option value="Authorization">Authorization</option>' +
                        '<option value="Host">Host</option>' +
                        '<option value="User-Agent">User-Agent</option>' +
                        '<option value="cookie">cookie</option>' +
                        '<option value="Content-Type" selected="">Content-Type</option>' +
                        '<option value="Content-Length">Content-Length</option>' +
                        '<option value="Connection">Connection</option>' +
                        '<option value="Accept-Charset">Accept-Charset</option>' +
                        '<option value="Referer">Referer</option>' +
                        '<option value="From">From</option>' +
                        '</select>' +
                        '</div>' +
                        '<div class="layui-inline">' +
                        '<label class="layui-form-label">参数值</label>' +
                        '<div class="layui-input-inline">' +
                        '<input type="text" name="header.value[' + count +
                        ']" autocomplete="off" class="layui-input" placeholder=" 例如&nbsp;application/json">' +
                        '</div>' +
                        '<input type="button" class="layui-btn" onclick="deleteTr(this)" value="删除">' +
                        '</div>' +
                        '<br>'
                    $('#head').append(str);

                    layui.use('form', function () {
                        let form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
                        form.render();
                    });
                    //选择移交单位 赋值给input框
                    for (let i = 1; i <= count; i++) {
                        form.on('select(hc_select_' + i + ')', function (
                            data) {
                            $('#HandoverCompany_' + i + '').val(data.value);
                            $('#hc_select_' + i + '').next().find("dl").css({
                                "display": "none"
                            });
                            form.render();
                        });
                    }
                });
            });
            form.on('select(hc_select_0)', function (data) { //选择移交单位 赋值给input框
                $('#HandoverCompany_0').val(data.value);
                $("#hc_select_0").next().find("dl").css({
                    "display": "none"
                });
                form.render();
            });

        });

        function deleteTr(event) {
            $(event).parent().prev().prev().remove();
            $(event).parent().prev().remove();
            $(event).parent().next().remove();
            $(event).parent().remove();
        }
    </script>

</body>

</html>